<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>VVVF インバータ音シミュレーター</title>
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; text-align: center; padding-top: 50px; }
        .panel { border: 2px solid #555; display: inline-block; padding: 20px; border-radius: 15px; background: #333; }
        .speed-display { font-size: 48px; font-family: 'Courier New', monospace; color: #0f0; margin: 20px; }
        button { padding: 15px 30px; font-size: 20px; cursor: pointer; margin: 10px; border-radius: 10px; border: none; }
        .accel { background: #d44; color: white; }
        .brake { background: #44d; color: white; }
        .stop { background: #777; color: white; }
        .info { font-size: 12px; color: #aaa; margin-top: 20px; }
    </style>
</head>
<body>

<div class="panel">
    <h2>VVVF Simulator</h2>
    <div class="speed-display"><span id="speed">0</span> km/h</div>
    
    <button class="accel" onmousedown="startAccel()" onmouseup="stopControl()" onmouseleave="stopControl()">加速 (Master Controller)</button><br>
    <button class="brake" onmousedown="startBrake()" onmouseup="stopControl()" onmouseleave="stopControl()">減速 (Brake)</button><br>
    <button class="stop" onclick="emergencyStop()">非常停止</button>

    <div class="info">
        ※ 音量にご注意ください。<br>
        加速ボタンを押し続けると、周波数が段階的に変化します。
    </div>
</div>

<script>
    let audioCtx = null;
    let mainOsc = null; // 非同期音（モーターの唸り）
    let carrierOsc = null; // キャリア音（キーンという音）
    let gainNode = null;
    
    let speed = 0;
    let timer = null;
    let isRunning = false;

    function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioCtx.createGain();
        gainNode.connect(audioCtx.destination);
        gainNode.gain.value = 0;
    }

    function updateSound(s) {
        if (!audioCtx) return;

        // --- モーターの根本音 (速度に比例) ---
        if (!mainOsc) {
            mainOsc = audioCtx.createOscillator();
            mainOsc.type = 'sawtooth';
            mainOsc.connect(gainNode);
            mainOsc.start();
        }
        mainOsc.frequency.setTargetAtTime(s * 1.5 + 10, audioCtx.currentTime, 0.1);

        // --- VVVFキャリア音 (段階的に切り替え) ---
        if (!carrierOsc) {
            carrierOsc = audioCtx.createOscillator();
            carrierOsc.type = 'sine';
            carrierOsc.connect(gainNode);
            carrierOsc.start();
        }

        let carrierFreq = 0;
        
        // シーメンス GTOやIGBTをイメージした簡易的な音階切り替え
        if (s < 5) {
            carrierFreq = 500; // 発車時
        } else if (s < 15) {
            carrierFreq = 700; // 非同期領域
        } else if (s < 25) {
            carrierFreq = 1100; // パルスモード切替 1
        } else if (s < 40) {
            carrierFreq = 1600; // パルスモード切替 2
        } else if (s < 60) {
            carrierFreq = 2500; // 高速域
        } else {
            carrierFreq = 3500 + (s * 5); // 高速域の伸び
        }

        carrierOsc.frequency.setTargetAtTime(carrierFreq, audioCtx.currentTime, 0.05);

        // 全体の音量調整（速度が上がると少し大きく、停止時は無音）
        let targetGain = s > 0 ? 0.15 : 0;
        gainNode.gain.setTargetAtTime(targetGain, audioCtx.currentTime, 0.1);
    }

    function startAccel() {
        initAudio();
        clearInterval(timer);
        timer = setInterval(() => {
            if (speed < 120) {
                speed += 0.5;
                document.getElementById('speed').innerText = Math.floor(speed);
                updateSound(speed);
            }
        }, 50);
    }

    function startBrake() {
        clearInterval(timer);
        timer = setInterval(() => {
            if (speed > 0) {
                speed -= 0.8;
                if (speed < 0) speed = 0;
                document.getElementById('speed').innerText = Math.floor(speed);
                updateSound(speed);
            }
        }, 50);
    }

    function stopControl() {
        clearInterval(timer);
    }

    function emergencyStop() {
        clearInterval(timer);
        speed = 0;
        document.getElementById('speed').innerText = "0";
        if (gainNode) gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
    }
</script>
</body>
</html>
