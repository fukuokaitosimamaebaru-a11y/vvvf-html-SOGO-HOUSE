<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ATS統合シミュレーター</title>
    <style>
        body { 
            background: #111; color: #000; font-family: 'MS Gothic', sans-serif;
            margin: 0; overflow-x: auto; overflow-y: hidden; white-space: nowrap;
        }
        .stage-container { display: inline-flex; height: 100vh; align-items: center; padding: 0 50vw; }
        
        .panel { 
            display: inline-block; background: #ffcc00; padding: 40px; border: 10px solid #000; 
            box-shadow: 20px 20px 0 #444; width: 380px; vertical-align: middle; 
            white-space: normal; margin: 0 100px;
        }

        h1 { font-size: 1.8rem; border-bottom: 5px solid #000; padding-bottom: 10px; margin-bottom: 20px; text-align: center;}
        .danger-stripes { height: 25px; background: repeating-linear-gradient(45deg, #000, #000 10px, #ffcc00 10px, #ffcc00 20px); margin-bottom: 10px; }

        .btn-group { display: flex; flex-direction: column; gap: 15px; }
        
        /* 統合起動ボタン */
        #masterStart { background: #00ff00; padding: 30px; font-size: 2rem; border: 5px solid #000; font-weight: bold; cursor: pointer; }
        #masterStart.active { animation: blink-green 0.5s infinite; background: #fff; }
        
        /* 停止ボタン */
        #emergencyStop { background: #ff0000; color: #fff; padding: 20px; font-size: 1.5rem; border: 5px solid #000; cursor: pointer; margin-top: 10px; }

        @keyframes blink-green { 0% { background: #00ff00; } 50% { background: #adff2f; } 100% { background: #00ff00; } }

        .status-window { background: #000; color: #0f0; padding: 15px; font-family: monospace; margin: 15px 0; border: 2px solid #555; }
        .hex-id { font-size: 0.7rem; color: #888; text-align: right; }
    </style>
</head>
<body>

    <div class="stage-container">
        
        <div class="panel">
            <div class="danger-stripes"></div>
            <h1>ATS 統合制御システム</h1>
            <div class="status-window" id="display">SYSTEM READY...</div>
            
            <div class="btn-group">
                <button id="masterStart">シミュレーター起動</button>
                <button id="emergencyStop">一括停止（復帰）</button>
            </div>
            
            <div class="hex-id">HEX-CORE / ATS-P CONNECTED</div>
        </div>

        <div class="panel">
            <div class="danger-stripes"></div>
            <h1 style="color: #d00;">非常警報【極】</h1>
            <p>※ATSとは別系統の独立回路</p>
            <button id="alarmBtn" style="width:100%; padding:40px; background:#d00; color:#fff; font-size:2rem; border:5px solid #000; cursor:pointer;">警報発令</button>
            <div class="hex-id" style="margin-top:20px;">EXTERNAL-NODE</div>
        </div>

    </div>

    <script>
        let audioCtx;
        let atsInterval;
        let isRunning = false;

        const setupAudio = () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        };

        const masterStart = document.getElementById('masterStart');
        const display = document.getElementById('display');

        // 統合起動ボタン
        masterStart.onclick = () => {
            setupAudio();
            if (isRunning) return;
            isRunning = true;
            masterStart.classList.add('active');
            display.textContent = "ATS RUNNING: キンコン... \nVERTICAL: STANDBY";

            let step = 0;
            atsInterval = setInterval(() => {
                const sampleRate = audioCtx.sampleRate;
                // ATS音 (キン=780Hz, コン=650Hz)
                const freq = (step % 2 === 0) ? 780 : 650;
                const buffer = audioCtx.createBuffer(1, sampleRate * 0.2, sampleRate);
                const data = buffer.getChannelData(0);

                for (let i = 0; i < buffer.length; i++) {
                    const env = Math.exp(-i / (sampleRate * 0.08));
                    // 物理打撃を強めるためのサイン波 + 矩形波のミックス
                    const wave = Math.sin(2 * Math.PI * freq * (i / sampleRate));
                    data[i] = wave * env;
                }
                
                playBuffer(buffer, 450); // ATSのリズムで垂直にノック
                step++;
            }, 600);
        };

        // 一括停止
        document.getElementById('emergencyStop').onclick = () => {
            isRunning = false;
            clearInterval(atsInterval);
            masterStart.classList.remove('active');
            display.textContent = "SYSTEM READY...";
        };

        // 火災報知器 (独立)
        document.getElementById('alarmBtn').onclick = () => {
            setupAudio();
            // 既存の音を止めずに重ねる
            setInterval(() => {
                const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.05, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < buffer.length; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.exp(-i / 1000);
                }
                playBuffer(buffer, 300);
            }, 60);
        };

        function playBuffer(buffer, gainVal) {
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(gainVal, audioCtx.currentTime);
            source.connect(gain);
            gain.connect(audioCtx.destination);
            source.start();
        }
    </script>
</body>
</html>
