<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>爆音VVVFプロトタイプ</title>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; padding: 20px; }
        .box { border: 3px solid #0f0; padding: 20px; display: inline-block; border-radius: 10px; background: #111; }
        .meter { font-size: 60px; margin: 20px; text-shadow: 0 0 10px #0f0; }
        button { 
            width: 250px; height: 60px; font-size: 20px; font-weight: bold; 
            margin: 10px; cursor: pointer; border-radius: 10px; border: 2px solid #0f0;
            background: #222; color: #0f0;
        }
        button:active { background: #0f0; color: #000; }
        .warn { color: #ff0000; font-size: 14px; margin-top: 10px; }
        input[type="range"] { width: 80%; }
    </style>
</head>
<body>

<div class="box">
    <h1>VVVF ENGINE v2</h1>
    
    <button id="unlockBtn" style="background: #f00; color: #fff;">1. UNLOCK AUDIO (まず押す)</button>
    <br>
    
    <div class="meter"><span id="speed">000</span> km/h</div>

    <button id="accelBtn">加速 (ACCEL)</button><br>
    <button id="brakeBtn">減速 (BRAKE)</button><br>
    
    <div>
        <label>MASTER VOLUME (注意)</label><br>
        <input type="range" id="volRange" min="0" max="2" step="0.1" value="0.5">
    </div>

    <div class="warn">※OS側の音量設定も確認してください</div>
</div>

<script>
    let audioCtx = null;
    let mainOsc = null;
    let carrierOsc = null;
    let gainNode = null;
    let speed = 0;
    let isAccelerating = false;
    let isBraking = false;

    // 初期化関数
    function init() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioCtx.createGain();
        gainNode.connect(audioCtx.destination);
        
        // オシレーター準備
        mainOsc = audioCtx.createOscillator();
        mainOsc.type = 'sawtooth'; // 唸り音
        
        carrierOsc = audioCtx.createOscillator();
        carrierOsc.type = 'square'; // 矩形波（より攻撃的な音）
        
        mainOsc.connect(gainNode);
        carrierOsc.connect(gainNode);
        
        mainOsc.start();
        carrierOsc.start();
        gainNode.gain.value = 0;
        
        document.getElementById('unlockBtn').textContent = "READY (OK)";
        document.getElementById('unlockBtn').style.background = "#004400";
    }

    // ロック解除ボタン
    document.getElementById('unlockBtn').addEventListener('click', () => {
        init();
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    });

    // 加速・減速のイベント（スマホ対応）
    const accelBtn = document.getElementById('accelBtn');
    const brakeBtn = document.getElementById('brakeBtn');

    const startAccel = () => { isAccelerating = true; };
    const stopAccel = () => { isAccelerating = false; };
    const startBrake = () => { isBraking = true; };
    const stopBrake = () => { isBraking = false; };

    accelBtn.onmousedown = startAccel; accelBtn.onmouseup = stopAccel; accelBtn.ontouchstart = startAccel; accelBtn.ontouchend = stopAccel;
    brakeBtn.onmousedown = startBrake; brakeBtn.onmouseup = stopBrake; brakeBtn.ontouchstart = startBrake; brakeBtn.ontouchend = stopBrake;

    // メインループ
    setInterval(() => {
        if (!audioCtx) return;

        if (isAccelerating) speed = Math.min(speed + 0.8, 120);
        if (isBraking) speed = Math.max(speed - 1.2, 0);

        document.getElementById('speed').innerText = Math.floor(speed).toString().padStart(3, '0');

        // 音の調整
        if (speed > 0) {
            let masterVol = document.getElementById('volRange').value;
            gainNode.gain.setTargetAtTime(masterVol, audioCtx.currentTime, 0.05);
            
            // モーター音
            mainOsc.frequency.setTargetAtTime(speed * 2 + 20, audioCtx.currentTime, 0.05);
            
            // VVVFキャリア音 (もっと複雑に動かす)
            let carrierFreq = 300;
            if (speed < 10) carrierFreq = 400 + speed * 20;
            else if (speed < 30) carrierFreq = 800;
            else if (speed < 50) carrierFreq = 1200;
            else carrierFreq = 2000 + (speed * 5);
            
            carrierOsc.frequency.setTargetAtTime(carrierFreq, audioCtx.currentTime, 0.05);
        } else {
            gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        }
    }, 50);
</script>

</body>
</html>
